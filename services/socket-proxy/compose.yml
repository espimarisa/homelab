---
services:
  ###########################################################################
  # Socket Proxy: Proxy wrapper for the Docker socket for secure access.    #
  ###########################################################################

  socket-proxy:
    image: ghcr.io/11notes/socket-proxy:2
    container_name: socket-proxy
    env_file: ../../.env
    hostname: socket-proxy
    read_only: true # Prevent writing directly to the image.
    restart: unless-stopped
    user: "0:${DOCKER_GID}" # Run with the host Docker group.
    environment:
      SOCKET_PROXY_UID: "${PUID}" # User to run as.
      SOCKET_PROXY_GID: "${PGID}" # Group to run as.
      TZ: "${TZ}" # Sets the timezone.
    expose:
      - 2375/tcp # Socket-proxy network access.
    networks:
      - internal
    volumes:
      - /run/docker.sock:/run/docker.sock:ro # Host Docker socket mount.
      - socket-proxy:/run/proxy # Socket-proxy volume.
    cap_drop:
      - AUDIT_WRITE
      - MKNOD
      - SETFCAP
      - SETPCAP
      - SYS_ADMIN
      - SYS_CHROOT
      - SYS_PTRACE
    deploy:
      resources:
        limits:
          cpus: 0.25 # Allow up to 0.25 vCPUs.
          memory: 32M # Allow up to 64MB of RAM.
    security_opt:
      - no-new-privileges:true # Do not allow privilege escalation.

networks:
  internal:
    external: true
    name: internal-network

volumes:
  socket-proxy:
    external: true
    name: socket-proxy-volume
