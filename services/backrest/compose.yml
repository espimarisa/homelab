###############################################################################
# Backrest: Web UI and orchestrator for Restic backups.                       #
# https://garethgeorge.github.io/backrest/introduction/getting-started/       #
###############################################################################

---
services:
  backrest:
    image: garethgeorge/backrest:v1.10.1-scratch
    container_name: backrest
    env_file: ../../.env
    hostname: backrest
    read_only: true
    restart: unless-stopped
    environment:
      BACKREST_CONFIG: "/config/config.json" # Sets the config file path.
      BACKREST_DATA: "/data" # Sets the config data path.
      DOCKER_HOST: "tcp://socket-proxy:2375" # Connect to socket-proxy.
      TMPDIR: "/tmp" # Use /tmp for temporary files.
      TZ: "${TZ}" # Sets the timezone.
      XDG_CACHE_HOME: "/cache" # Use /cache for cached files.
    expose:
      - 9898/tcp
    networks:
      - external
      - internal
    volumes:
      - backrest-cache:/cache:rw
      - backrest-config:/config:rw
      - backrest-data:/data:rw
      - backrest-hdd:/mnt/backup-hdd:rw
      - backrest-tmp:/tmp:rw
      - docker-volumes:/mnt/docker-volumes:ro
      - storage:/mnt/storage:ro
    cap_drop:
      - AUDIT_WRITE
      - MKNOD
      - SYS_ADMIN
      - SYS_CHROOT
      - SYS_PTRACE
    depends_on:
      socket-proxy:
        condition: service_healthy
        restart: true
    deploy:
      resources:
        limits:
          cpus: 4
          memory: 4G
        reservations:
          cpus: 1
          memory: 1G
    security_opt:
      - no-new-privileges:true

networks:
  external:
    name: external-network
    external: true
  internal:
    name: internal-network
    external: true

volumes:
  backrest-data:
    name: backrest-data-volume
    external: true
  backrest-cache:
    name: backrest-cache-volume
    external: true
  backrest-config:
    name: backrest-config-volume
    external: true
  backrest-tmp:
    name: backrest-tmp-volume
    external: true
  docker-volumes:
    name: docker-volumes-bind
    driver_opts:
      device: "${DOCKER_VOLUMES_PATH}"
      o: bind
      type: none
  backrest-hdd:
    name: backrest-hdd-bind
    driver_opts:
      device: "${BACKUPS_PATH}"
      o: bind
      type: none
  storage:
    name: storage-bind
    driver_opts:
      device: "${STORAGE_PATH}"
      o: bind
      type: none
