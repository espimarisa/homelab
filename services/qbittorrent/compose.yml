###########################################################################
# qBittorrent: BitTorrent client - https://www.qbittorrent.org/           #
###########################################################################

---
services:
  qbittorrent:
    image: ghcr.io/11notes/qbittorrent:5 # https://github.com/11notes/docker-qbittorrent
    container_name: qbittorrent
    network_mode: service:gluetun # Route all traffic through Gluetun.
    read_only: true # Prevent writing directly to the image.
    restart: unless-stopped
    environment:
      TZ: "${TZ}" # Sets the timezone.
    volumes:
      - downloads:/downloads:rw # Root downloads path.
      - downloads-incomplete:/downloads-incomplete:rw # Root incomplete downloads cache path.
      - qbittorrent-config:/qbittorrent/etc:rw # qBittorrent configuration.
      - qbittorrent-data:/qbittorrent/var:rw # qBittorrent cache and database.
    cap_drop:
      - ALL # Drop all default capabilities.
    depends_on:
      gluetun:
        condition: service_healthy # Wait for Gluetun to be healthy before connecting.
        restart: true # Restart when Gluetun restarts.
    deploy:
      resources:
        limits:
          cpus: 8 # Allow up to 8 vCPUs.
          memory: 8GB # Allow up to 8GB of RAM usage.
        reservations:
          cpus: 1 # Reserve 1 vCPU.
          memory: 1G # Reserve 1GB of RAM.
    security_opt:
      - no-new-privileges:true # Do not allow privilege escalation.

volumes:
  qbittorrent-config:
    name: qbittorrent-config-volume
    external: true
  qbittorrent-data:
    name: qbittorrent-data-volume
    external: true
  downloads:
    name: downloads-bind
    driver_opts:
      device: "${DOWNLOADS_PATH}"
      o: bind
      type: none
  downloads-incomplete:
    name: downloads-incomplete-bind
    driver_opts:
      device: "${DOWNLOADS_INCOMPLETE_PATH}"
      o: bind
      type: none
