---
# Default container settings.
x-defaults: &defaults
  restart: unless-stopped
  read_only: true # Prevent writing directly to the image.
  network_mode: service:gluetun # Route all traffic through Gluetun.
  environment:
    TZ: "${TZ}" # Sets the timezone.
  cap_add:
    - CHOWN # Required for taking ownership.
  cap_drop:
    - ALL # Drop all default capabilities.
  depends_on:
    gluetun:
      condition: service_healthy # Wait for Gluetun to be healthy before connecting.
      restart: true # Restart when Gluetun restarts.
  security_opt:
    - no-new-privileges:true # Do not allow privilege escalation.

services:
  ###########################################################################
  # qBittorrent: BitTorrent client - https://www.qbittorrent.org/           #
  ###########################################################################

  qbittorrent:
    <<: *defaults
    image: ghcr.io/11notes/qbittorrent:5.1.2
    container_name: qbittorrent
    volumes:
      - downloads:/downloads # Root downloads path.
      - dl-cache:/dl-cache # Root downloads cache path.
      - qbittorrent-config:/qbittorrent/etc # Configuration path.
      - qbittorrent-data:/qbittorrent/var # Data path.
    deploy:
      resources:
        limits:
          cpus: 6 # Allow up to 6 vCPUs.
          memory: 4G # Allow up to 4GB of RAM usage.
        reservations:
          cpus: 2 # Reserve 2 vCPUs.
          memory: 1G # Reserve 1GB of RAM.

  ###########################################################################
  # qui: Alternate web UI for qBittorrent - https://github.com/autobrr/qui  #
  ###########################################################################

  qui:
    <<: *defaults
    image: ghcr.io/autobrr/qui:v1.5.0
    container_name: qui
    user: "${PUID}:${PGID}" # Run as non-root user.
    environment:
      QUI__LOG_LEVEL: "info" # Log at the info level.
      QUI__LOG_MAX_SIZE: "10" # Rotate 10mb per file.
      QUI__LOG_PATH: "/config/logs/qui.log" # Log path.
      QUI__PORT: "7476" # Sets the port.
      QUI__SESSION_SECRET: "${QUI_SESSION_SECRET}" # Session secret to use.
      TZ: "${TZ}" # Sets the timezone.
    volumes:
      - qui-config:/config # qui config and database.
      - qui-logs:/config/logs # qui logs.
    depends_on:
      gluetun:
        condition: service_healthy # Require Gluetun to be healthy before connecting.
        restart: true # Restart when Gluetun is restarted.
      qbittorrent:
        condition: service_healthy # Require qBittorrent to be healthy before connecting.
        restart: true # Restart when qBittorrent restarts.
    deploy:
      resources:
        limits:
          cpus: 0.5 # Allow up to 0.5 vCPUs.
          memory: 512M # Allow up to 512MB of RAM usage.
        reservations:
          cpus: 0.125 # Reserve 0.125 vCPUs.
          memory: 128M # Reserve 128MB of RAM.

volumes:
  qbittorrent-config:
    name: qbittorrent-config-volume
    external: true
  qbittorrent-data:
    name: qbittorrent-data-volume
    external: true
  qui-config:
    name: qui-config-volume
    external: true
  qui-logs:
    name: qui-logs-volume
    external: true
  dl-cache:
    name: dl-cache
    driver_opts:
      device: "${DOWNLOADS_CACHE_PATH}"
      o: bind
      type: none
  downloads:
    name: downloads-bind
    driver_opts:
      device: "${DOWNLOADS_PATH}"
      o: bind
      type: none
