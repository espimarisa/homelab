services:
  ###########################################################################
  # OpenCloud: Self-hosted cloud storage service - https://opencloud.eu/en  #
  ###########################################################################

  opencloud:
    image: opencloudeu/opencloud-rolling:3.5.0
    command: ["-c", "opencloud init --insecure true || true; opencloud server"]
    container_name: opencloud
    entrypoint: /bin/sh
    env_file: ../../.env
    hostname: opencloud
    read_only: true
    restart: unless-stopped
    user: "${PUID}:${PGID}"
    environment:
      FRONTEND_ARCHIVER_MAX_SIZE: "10000000000"
      IDM_ADMIN_PASSWORD: "${OPENCLOUD_ADMIN_PASSWORD}"
      IDM_CREATE_DEMO_USERS: "false"
      NOTIFICATIONS_SMTP_ENCRYPTION: "${SMTP_TRANSPORT_ENCRYPTION}"
      NOTIFICATIONS_SMTP_HOST: "${SMTP_HOST}"
      NOTIFICATIONS_SMTP_INSECURE: "${SMTP_INSECURE}"
      NOTIFICATIONS_SMTP_PASSWORD: "${SMTP_PASSWORD}"
      NOTIFICATIONS_SMTP_PORT: "${SMTP_PORT}"
      NOTIFICATIONS_SMTP_SENDER: "OpenCloud <${SMTP_SENDER}>"
      NOTIFICATIONS_SMTP_USERNAME: "${SMTP_USERNAME}"
      OC_ADD_RUN_SERVICES: "notifications"
      OC_INSECURE: "false"
      OC_LOG_COLOR: "true"
      OC_LOG_LEVEL: "info"
      OC_LOG_PRETTY: "false"
      OC_SHARING_PUBLIC_SHARE_MUST_HAVE_PASSWORD: "false"
      OC_SHARING_PUBLIC_WRITEABLE_SHARE_MUST_HAVE_PASSWORD: "true"
      OC_URL: "https://${OPENCLOUD_URL}"
      PROXY_TLS: "false"
      TZ: "${TZ}"
    expose:
      - 9200/tcp
    extra_hosts:
      - "${OPENCLOUD_URL}:host-gateway"
    networks:
      - caddy
    tmpfs:
      - "/tmp:uid=${PUID},gid=${PGID}"
    volumes:
      - opencloud-config:/etc/opencloud
      - opencloud-data:/var/lib/opencloud
    cap_drop:
      - ALL
    healthcheck:
      test: "wget --spider http://127.0.0.1:9200 || exit 1"
    security_opt:
      - no-new-privileges:true
