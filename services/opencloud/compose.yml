---
x-defaults: &defaults
  env_file: ../../.env
  read_only: true # Prevent writing directly to the image.
  restart: unless-stopped
  user: "${PUID}:${PGID}" # Run as non-root user.
  networks:
    - external
  cap_drop:
    - ALL # Drop all default capabilities.
  security_opt:
    - no-new-privileges:true # Do not allow privilege escalation.

services:
  ###########################################################################
  # OpenCloud: Self-hosted cloud storage service - https://opencloud.eu/en  #
  ###########################################################################

  opencloud:
    image: opencloudeu/opencloud-rolling:3
    command: ["-c", "opencloud init --insecure true || true; opencloud server"]
    container_name: opencloud
    entrypoint: /bin/sh # Enter in /bin/sh for CLI commands.
    hostname: opencloud
    environment:
      FRONTEND_ARCHIVER_MAX_SIZE: "10000000000" # Sets the max archive size.
      IDM_ADMIN_PASSWORD: "${OPENCLOUD_ADMIN_PASSWORD}" # Sets the admin password.
      IDM_CREATE_DEMO_USERS: "false" # Do not create demo users.
      NOTIFICATIONS_SMTP_ENCRYPTION: "${SMTP_TRANSPORT_ENCRYPTION}" # Configures SMTP encryption.
      NOTIFICATIONS_SMTP_HOST: "${SMTP_HOST}" # Configures SMTP host.
      NOTIFICATIONS_SMTP_INSECURE: "${SMTP_INSECURE}" # Toggles SMTP insecure mode.
      NOTIFICATIONS_SMTP_PASSWORD: "${SMTP_PASSWORD}" # Configures SMTP password.
      NOTIFICATIONS_SMTP_PORT: "${SMTP_PORT}" # Configures SMTP port.
      NOTIFICATIONS_SMTP_SENDER: "OpenCloud <${SMTP_SENDER}>" # Configures SMTP sender.
      NOTIFICATIONS_SMTP_USERNAME: "${SMTP_USERNAME}" # Configures SMTP username.
      OC_ADD_RUN_SERVICES: "notifications" # Run the notifications service.
      OC_INSECURE: "false" # Do not run in insecure mode.
      OC_LOG_COLOR: "true" # Log in color.
      OC_LOG_LEVEL: "info" # Log info and above.
      OC_LOG_PRETTY: "true" # Use pretty logs.
      OC_SHARING_PUBLIC_SHARE_MUST_HAVE_PASSWORD: "false" # Allow public shares.
      OC_SHARING_PUBLIC_WRITEABLE_SHARE_MUST_HAVE_PASSWORD: "true" # Require writable public shares to have a password.
      OC_URL: "https://${OPENCLOUD_URL}" # Configures the URL.
      PROXY_TLS: "false" # Do not proxy between backend and reverse proxy.
      TZ: "${TZ}" # Sets the timezone.
    expose:
      - 9200/tcp # Web interface reverse proxied externally at ${OPENCLOUD_URL}.
    tmpfs:
      - "/tmp:uid=${PUID},gid=${PGID}" # Required for read_only image.
    volumes:
      - opencloud-config:/etc/opencloud # Configuration and data.
      - opencloud-data:/var/lib/opencloud # User data.
    deploy:
      resources:
        limits:
          cpus: 4 # Allow up to 4 vCPUs.
          memory: 4G # Allow up to 4G of RAM.
    healthcheck:
      test: "wget --spider http://127.0.0.1:9200 || exit 1"

  ###########################################################################
  # Anubis: Anti-bot/scraper tool - https://anubis.techaro.lol              #
  ###########################################################################

  opencloud-anubis:
    <<: *defaults
    image: ghcr.io/techarohq/anubis:latest
    container_name: opencloud-anubis
    hostname: opencloud-anubis
    environment:
      BIND: ":9200" # Bind to the used container port.
      ED25519_PRIVATE_KEY_HEX: "${OPENCLOUD_ANUBIS_KEY}" # Sets the private key.
      REDIRECT_DOMAINS: "*.${OPENCLOUD_URL}" # Sets allowed redirect URLs.
      SERVE_ROBOTS_TXT: "true" # Serve a default robots.txt.
      SLOG_LEVEL: "DEBUG" # Log more things.
      TARGET: "http://opencloud:9200" # Target the container.
      TZ: "${TZ}" # Sets the timezone.
      WEBMASTER_EMAIL: "${ACME_EMAIL}" # Sets the webmaster email.
    depends_on:
      caddy:
        condition: service_healthy # Require Caddy to be healthy.
        restart: true # Restart when Caddy restarts.
      opencloud:
        condition: service_healthy # Require OpenCloud to be healthy.
        restart: true # Restart when OpenCloud restarts.
    deploy:
      resources:
        limits:
          cpus: 0.25 # Allow up to 0.25 vCPUs.
          memory: 64M # Allow up to 64MB of RAM.
    healthcheck:
      test: ["CMD", "anubis", "--healthcheck"]

networks:
  external:
    external: true
    name: external-network

volumes:
  opencloud-config:
    name: opencloud-config-volume
    external: true
  opencloud-data:
    name: opencloud-data-bind
    driver_opts:
      device: "${APPDATA_PATH}/opencloud"
      o: bind
      type: none
