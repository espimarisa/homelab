---
x-defaults: &defaults
  restart: unless-stopped
  cap_drop:
    - ALL # Drop all default capabilities.
  security_opt:
    - no-new-privileges:true # Do not allow privilege escalation.

services:
  ###########################################################################
  # Seerr: Media request tool - https://docs.seerr.dev/                     #
  ###########################################################################

  seerr:
    <<: *defaults
    image: ghcr.io/fallenbagel/jellyseerr:2.7.3
    container_name: seerr
    hostname: seerr
    user: "${PUID}:${PGID}" # Run as non-root user.
    environment:
      DB_TYPE: "postgres" # Use PostgreSQL.
      DB_HOST: "seerr-db" # Connect to seerr-db.
      DB_PORT: "5432" # Connect to port 5432.
      DB_USER: "postgres" # Use postgres user.
      DB_PASS: "${SEERR_DB_PASSWORD}" # Password to authenticate with.
      DB_NAME: "postgres" # Use the postgres database.
      DB_LOG_QUERIES: "false" # Do not log queries.
      DB_USE_SSL: "false" # Do not use SSL.
      TZ: "${TZ}" # Sets the timezone.
    expose:
      - 5055:5055/tcp # Web interface reverse proxied externally at ${SEERR_URL}.
    networks:
      - caddy
      - internal-only
    volumes:
      - seerr:/app/config # Configuration and database.
    depends_on:
      seerr-db:
        condition: service_healthy # Require seerr-db to be healthy before connecting.
        restart: true # Restart when seerr-db restarts.
    deploy:
      resources:
        limits:
          cpus: 1 # Allow up to 1 vCPU.
          memory: 1G # Allow using 1G of RAM.
        reservations:
          cpus: 0.25 # Reserve 0.25 vCPUs.
          memory: 256M # Reserve 256MB of RAM.
    healthcheck:
      test: "wget --spider http://127.0.0.1:5055/api/v1/status || exit 1"

  seerr-db:
    <<: *defaults
    image: ghcr.io/11notes/postgres:17
    container_name: seerr-db
    hostname: seerr-db
    environment:
      TZ: "${TZ}" # Sets the timezone.
      POSTGRES_BACKUP_SCHEDULE: "0 6 * * *" # Run every night at 6AM.
      POSTGRES_PASSWORD: "${SEERR_DB_PASSWORD}" # Configures the default PostgreSQL password.
    networks:
      - internal-only # Internal network.
    tmpfs:
      - "/postgres/log:uid=${PUID},gid=${PGID}" # Required for read_only image.
      - "/postgres/run:uid=${PUID},gid=${PGID}" # Required for read_only image.
    volumes:
      - seerr-db-backups:/postgres/backup:rw # PostgreSQL backups.
      - seerr-db-config:/postgres/etc:rw # PostgreSQL configuration.
      - seerr-db-data:/postgres/var:rw # PostgreSQL data.
    deploy:
      resources:
        limits:
          cpus: 0.5 # Allow up to 0.5 vCPUs.
          memory: 256M # Allow using 256MB of RAM.
        reservations:
          cpus: 0.125 # Reserve 0.125 vCPUs.
          memory: 128M # Reserve 256M of RAM.

networks:
  caddy:
    external: true
    name: caddy-network
    ipam:
      config:
        - subnet: 172.18.0.0/16 # Always use the 172.18.0.0/16 subnet.
          gateway: 172.18.0.1
  internal-only:
    external: true
    ipam:
      config:
        - subnet: 172.20.0.0/16 # Always use the 172.20.0.0/16 subnet.
          gateway: 172.20.0.1
    name: internal-only-network

volumes:
  seerr:
    external: true
    name: seerr-volume
  seerr-db-backups:
    name: seerr-db-backups-volume
    external: true
  seerr-db-config:
    name: seerr-db-config-volume
    external: true
  seerr-db-data:
    name: seerr-db-data-volume
    external: true
