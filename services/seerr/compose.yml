---
x-defaults: &defaults
  env_file: ../../.env
  restart: unless-stopped
  user: "${PUID}:${PGID}" # Run as non-root user.
  cap_drop:
    - ALL # Drop all default capabilities.
  security_opt:
    - no-new-privileges:true # Do not allow privilege escalation.

services:
  ###########################################################################
  # Seerr: Media request tool - https://docs.seerr.dev/                     #
  ###########################################################################

  seerr:
    <<: *defaults
    image: ghcr.io/fallenbagel/jellyseerr:2
    container_name: seerr
    hostname: seerr
    environment:
      DB_TYPE: "postgres" # Use PostgreSQL.
      DB_HOST: "seerr-db" # Connect to seerr-db.
      DB_PORT: "5432" # Connect to port 5432.
      DB_USER: "postgres" # Use postgres user.
      DB_PASS: "${SEERR_DB_PASSWORD}" # Password to authenticate with.
      DB_NAME: "postgres" # Use the postgres database.
      DB_LOG_QUERIES: "false" # Do not log queries.
      DB_USE_SSL: "false" # Do not use SSL.
      TZ: "${TZ}" # Sets the timezone.
    expose:
      - 5055:5055/tcp # Web interface reverse proxied externally at ${SEERR_URL}.
    networks:
      - external
      - internal
    volumes:
      - seerr:/app/config # Configuration and database.
    depends_on:
      seerr-db:
        condition: service_healthy # Require seerr-db to be healthy before connecting.
        restart: true # Restart when seerr-db restarts.
    deploy:
      resources:
        limits:
          cpus: 1 # Allow up to 1 vCPU.
          memory: 1G # Allow using 1G of RAM.
    healthcheck:
      test: "wget --spider http://127.0.0.1:5055/api/v1/status || exit 1"

  seerr-db:
    <<: *defaults
    image: ghcr.io/11notes/postgres:17
    container_name: seerr-db
    hostname: seerr-db
    environment:
      TZ: "${TZ}" # Sets the timezone.
      POSTGRES_BACKUP_SCHEDULE: "0 6 * * *" # Run every night at 6AM.
      POSTGRES_PASSWORD: "${SEERR_DB_PASSWORD}" # Configures the default PostgreSQL password.
    networks:
      - internal
    tmpfs:
      - "/postgres/log:uid=${PUID},gid=${PGID}" # Required for read_only image.
      - "/postgres/run:uid=${PUID},gid=${PGID}" # Required for read_only image.
    volumes:
      - seerr-db-backups:/postgres/backup:rw # PostgreSQL backups.
      - seerr-db-config:/postgres/etc:rw # PostgreSQL configuration.
      - seerr-db-data:/postgres/var:rw # PostgreSQL data.
    deploy:
      resources:
        limits:
          cpus: 0.5 # Allow up to 0.5 vCPUs.
          memory: 256M # Allow using 256MB of RAM.

  ###########################################################################
  # Anubis: Anti-bot/scraper tool - https://anubis.techaro.lol              #
  ###########################################################################

  seerr-anubis:
    <<: *defaults
    image: ghcr.io/techarohq/anubis:latest
    container_name: seerr-anubis
    hostname: seerr-anubis
    read_only: true
    networks:
      - external
    environment:
      BIND: ":5055" # Bind to the used container port..
      ED25519_PRIVATE_KEY_HEX: "${SEERR_ANUBIS_KEY}" # Sets the private key.
      REDIRECT_DOMAINS: "*.${SEERR_URL}" # Sets allowed redirect URLs.
      SERVE_ROBOTS_TXT: "true" # Serve a default robots.txt.
      SLOG_LEVEL: "DEBUG" # Log more things.
      TARGET: "http://seerr:5055" # Target the container.
      TZ: "${TZ}" # Sets the timezone.
      WEBMASTER_EMAIL: "${ACME_EMAIL}" # Sets the webmaster email.
    depends_on:
      caddy:
        condition: service_healthy # Require Caddy to be healthy.
        restart: true # Restart when Caddy restarts.
      seerr:
        condition: service_healthy # Require Seerr to be healthy.
        restart: true # Restart when Seerr restarts.
    deploy:
      resources:
        limits:
          cpus: 0.25 # Allow using 0.25 vCPUs.
          memory: 64MB # Allow using 64MB of RAM.
    healthcheck:
      test: ["CMD", "anubis", "--healthcheck"]

networks:
  external:
    external: true
    name: external-network
  internal:
    external: true
    name: internal-network

volumes:
  seerr:
    external: true
    name: seerr-volume
  seerr-db-backups:
    name: seerr-db-backups-volume
    external: true
  seerr-db-config:
    name: seerr-db-config-volume
    external: true
  seerr-db-data:
    name: seerr-db-data-volume
    external: true
