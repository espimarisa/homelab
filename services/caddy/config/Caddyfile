{
	# ACME configuration.
	acme_ca https://acme.zerossl.com/v2/DV90 # Use ZeroSSL for SSL certificates.
	acme_dns cloudflare {$CLOUDFLARE_API_KEY} # Use Cloudflare for ACME DNS challenges.
	email {$ACME_EMAIL} # Configures the email to use for ACME.

	# Dynamic DNS configuration.
	dynamic_dns {
		# Use Cloudflare DNS.
		provider cloudflare {$CLOUDFLARE_API_KEY}
		check_interval 1h # Check for an updated IP every hour.

		# List of domains to update.
		domains {
			{$DOMAIN} {$DDNS_SUBDOMAINS} # Should be parsed as "example.com home vault test example".
		}
	}

	# Global server configuration.
	servers {
		# Trust private ranges for reverse proxying.
		trusted_proxies combine {
			cloudflare
			static private_ranges 100.64.0.0/10
		}
	}
}

# Snippet for security headers.
(security_headers) {
	header {
		-Server # Remove the Server header.
		Referrer-Policy "strict-origin-when-cross-origin" # Control referrer information.
		Strict-Transport-Security "max-age=31536000; includeSubDomains; preload" # Enable HSTS.
		X-Content-Type-Options "nosniff" # Prevent browser from MIME-type sniffing.
		X-Frame-Options "DENY" # Prevent clickjacking attacks.
	}
}

# Snippet for externally accessible reverse proxied services.
(external_proxy) {
	encode zstd gzip
	reverse_proxy {args[0]}
}

# Snippet for internal-only reverse proxied services.
(internal_proxy) {
	# Define @not_internal as non-private ranges + non-Tailscale ranges.
	@not_internal not remote_ip private_ranges 100.64.0.0/10
	tls internal
	abort @not_internal
	encode zstd gzip
	reverse_proxy {args[0]}
}

# Internal healthcheck.
:3000 {
	respond / 200
}

#################################################
# Externally accessible services.				#
#################################################

{$CHHOTO_URL} {
	import external_proxy chhoto:4567
	import security_headers
}

{$GATUS_URL} {
	import external_proxy gatus:8080
	import security_headers
}

{$HOMARR_URL} {
	import external_proxy homarr:7575
	import security_headers
}

{$JELLYFIN_URL} {
	import external_proxy jellyfin:8096
	import security_headers
}

{$OPENCLOUD_URL} {
	import external_proxy opencloud:9200
	import security_headers
}

{$THELOUNGE_URL} {
	import external_proxy thelounge:9000
	import security_headers
}

{$VAULTWARDEN_URL} {
	import external_proxy vaultwarden:80

	header {
		Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"
	}
}

#################################################
# Internal-only services.						#
#################################################

autobrr.{$INTERNAL_DOMAIN} {
	import internal_proxy gluetun:7474
}

beszel.{$INTERNAL_DOMAIN} {
	import internal_proxy beszel:8090
}

cleanuparr.{$INTERNAL_DOMAIN} {
	import internal_proxy cleanuparr:11011
}

dozzle.{$INTERNAL_DOMAIN} {
	import internal_proxy dozzle:8080
}

huntarr.{$INTERNAL_DOMAIN} {
	import internal_proxy huntarr:9705
}

lidarr.{$INTERNAL_DOMAIN} {
	import internal_proxy lidarr:8686
}

prowlarr.{$INTERNAL_DOMAIN} {
	import internal_proxy gluetun:9696
}

qbittorrent.{$INTERNAL_DOMAIN} {
	import internal_proxy gluetun:8080
}

radarr.{$INTERNAL_DOMAIN} {
	import internal_proxy radarr:7878
}

readarr.{$INTERNAL_DOMAIN} {
	import internal_proxy readarr:8787
}

slskd.{$INTERNAL_DOMAIN} {
	import internal_proxy gluetun:5030
}

sonarr.{$INTERNAL_DOMAIN} {
	import internal_proxy sonarr:8989
}
