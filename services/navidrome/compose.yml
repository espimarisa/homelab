---
services:
  ###########################################################################
  # Navidrome: Music media server - https://www.navidrome.org/              #
  ###########################################################################

  navidrome:
    image: ghcr.io/navidrome/navidrome:latest
    container_name: navidrome
    hostname: navidrome
    read_only: true # Prevent writing directly to the image.
    restart: unless-stopped
    user: "${PUID}:${PGID}" # Run as non-root user.
    environment:
      ND_BACKUP_COUNT: "7" # Store up to 7 backups.
      ND_BACKUP_PATH: "/backups" # Backup path.
      ND_BACKUP_SCHEDULE: "0 6 * * *" # Backup every day at 6AM.
      ND_CACHEFOLDER: "/cache" # Configures the cache folder.
      ND_DEFAULTDOWNLOADABLESHARE: "true" # Allow shares to be downloaded.
      ND_ENABLEGRAVATAR: "true" # Enables gravatar support.
      ND_ENABLEINSIGHTSCOLLECTOR: "false" # Opts out of telemetry.
      ND_ENABLESHARING: "true" # Enables the sharing API.
      ND_LASTFM_APIKEY: "${LASTFM_API_KEY}" # Sets Last.fm API key.
      ND_LASTFM_ENABLED: "true" # Enables Last.fm support.
      ND_LASTFM_LANGUAGE: "en" # Use English for Last.fm.
      ND_LASTFM_SECRET: "${LASTFM_API_SECRET}" # Sets Last.fm API Secret.
      ND_LOGLEVEL: "info" # Log at the info level.
      ND_MUSICFOLDER: "/library/music" # Search for music at /library/music.
      ND_PASSWORDENCRYPTIONKEY: "${NAVIDROME_ENCRYPTION_KEY}" # Configures the encryption key.
      ND_SCANNER_SCHEDULE: "0 6 * * *" # Scan every day at 6AM.
      ND_SPOTIFY_ID: "${SPOTIFY_ID}" # Sets the Spotify application ID.
      ND_SPOTIFY_SECRET: "${SPOTIFY_SECRET}" # Sets the Spotify secret.
      ND_UIWELCOMEMESSAGE: "${NAVIDROME_WELCOME_MESSAGE}" # Sets the welcome message.
      SQLITE_TMPDIR: "/data" # Sets the SQLite directory.
    expose:
      - 4533/tcp # Web interface reverse proxied externally at ${NAVIDROME_URL}.
    networks:
      - caddy
    volumes:
      - media-library:/library:ro # Read-only media library mount.
      - navidrome-backups:/backups # Navidrome backups.
      - navidrome-cache:/cache # Navidrome cache.
      - navidrome-data:/data # Navidrome data.
    cap_drop:
      - ALL # Drop all default capabilities.
    deploy:
      resources:
        limits:
          cpus: 2 # Allow up to 2 vCPUs.
          memory: 2G # Allow up to 2GB of RAM usage.
        reservations:
          cpus: 0.5 # Reserve 0.5 vCPUs.
          memory: 512M # Reserve 512MB of RAM.
    healthcheck:
      test: "wget --spider http://127.0.0.1:4533/ping || exit 1"
    security_opt:
      - no-new-privileges:true # Do not allow privilege escalation.

networks:
  caddy:
    external: true
    name: caddy-network
    ipam:
      config:
        - subnet: 172.18.0.0/16 # Always use the 172.18.0.0/16 subnet.
          gateway: 172.18.0.1

volumes:
  navidrome-backups:
    external: true
    name: navidrome-backups-volume
  navidrome-cache:
    external: true
    name: navidrome-cache-volume
  navidrome-data:
    external: true
    name: navidrome-data-volume
  media-library:
    name: media-library-bind
    driver_opts:
      device: "${MEDIA_LIBRARY_PATH}"
      o: bind
      type: none
