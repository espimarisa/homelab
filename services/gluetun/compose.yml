services:
  ###########################################################################
  # Gluetun: VPN - https://github.com/qdm12/gluetun                         #
  ###########################################################################

  gluetun:
    image: ghcr.io/qdm12/gluetun:v3.39.1 # Held back due to occasional hiccups on v3.40 and up.
    container_name: gluetun
    env_file: ../../.env
    hostname: gluetun
    restart: unless-stopped
    devices:
      - /dev/net/tun:/dev/net/tun
    environment:
      BLOCK_ADS: "off"
      BLOCK_MALICIOUS: "off"
      BLOCK_SURVEILLANCE: "off"
      DOT: "off" # Disable due to some weird DOT issues.
      FIREWALL_OUTBOUND_SUBNETS: "${FIREWALL_OUTBOUND_SUBNETS}"
      FIREWALL_VPN_INPUT_PORTS: "${FIREWALL_VPN_INPUT_PORTS}"
      HEALTH_TARGET_ADDRESS: "www.quad9.net:443"
      HEALTH_VPN_DURATION_INITIAL: "60s"
      HTTPPROXY: "off"
      PGID: "${PGID}"
      PUID: "${PUID}"
      SERVER_CITIES: "${SERVER_CITIES}"
      SERVER_COUNTRIES: "${SERVER_COUNTRIES}"
      SERVER_HOSTNAMES: "${SERVER_HOSTNAMES}"
      SERVER_NAMES: "${SERVER_NAMES}"
      SERVER_REGIONS: "${SERVER_REGIONS}"
      SHADOWSOCKS: "off"
      TZ: "${TZ}"
      UPDATER_PERIOD: "24h"
      VPN_SERVICE_PROVIDER: "${VPN_SERVICE_PROVIDER}"
      VPN_TYPE: "wireguard"
      WIREGUARD_ADDRESSES: "${WIREGUARD_ADDRESSES}"
      WIREGUARD_ENDPOINT_PORT: "${WIREGUARD_ENDPOINT_PORT}"
      WIREGUARD_MTU: "1280"
      WIREGUARD_PERSISTENT_KEEPALIVE_INTERVAL: "25s"
      WIREGUARD_PRESHARED_KEY: "${WIREGUARD_PRESHARED_KEY}"
      WIREGUARD_PRIVATE_KEY: "${WIREGUARD_PRIVATE_KEY}"
      WIREGUARD_PUBLIC_KEY: "${WIREGUARD_PUBLIC_KEY}"
    expose:
      - "${SOULSEEK_PORT:-50300}/tcp"
      - 5030/tcp
      - 8080/tcp
      - 8191/tcp
      - 9696/tcp
    networks:
      - caddy
      - gluetun
      - internal-only
    volumes:
      - gluetun:/gluetun
    cap_add:
      - NET_ADMIN
    cap_drop:
      - AUDIT_WRITE
      - MKNOD
      - SETFCAP
      - SYS_ADMIN
      - SYS_CHROOT
      - SYS_PTRACE
    security_opt:
      - no-new-privileges:true
